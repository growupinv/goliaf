import{ax as ee,r as s,c as i,ay as te,u as ae,ap as re}from"./index-ff671c6d.js";import{u as le}from"./usePartnerStore-c5291516.js";const oe=ee("tree",()=>{const h=s(""),f=s(null),b=s([]),C=s([]),g=s([]),d=s(new Set),n=s(0),v=s(0),p=s([0,0]),m=s("all"),y=s("all"),E=s(!1),k=s(!1),q=s(new Set),S=s(!1),K=i(()=>F.value.length),A=async(e,t=1e3)=>{S.value=!0;const a=te();ae();const l=async u=>{let r=[],c=1,o=!0;for(;o;)try{const P={data:{partner_store_id:e,page:c,limit:t},user_id:a.user.id,user_tg:a.user.user_tg},U=(await re.post(u,{payload:P})).data.payload;r=r.concat(U),o=U.length===t,c++}catch(P){console.error(`Error fetching data from ${u}:`,P),o=!1}return r};try{const[u,r,c]=await Promise.all([l("/mypartnerstorescategorys"),l("/mypartnerstoressubcategorys"),l("/mypartnerstoresproducts")]);b.value=u,C.value=r,g.value=c,D()}catch(u){console.error("Error in fetchData:",u),b.value=[],C.value=[],g.value=[],S.value=!1}finally{S.value=!1}},D=()=>{if(g.value.length===0){n.value=v.value=0,p.value=[0,0];return}const e=g.value.map(t=>t.product_price);n.value=Math.min(...e),v.value=Math.max(...e),n.value===v.value&&(n.value=Math.max(0,n.value-1),v.value+=1),p.value=[n.value,v.value]},x=e=>{p.value=[Math.max(n.value,Math.min(...e)),Math.min(v.value,Math.max(...e))],_()},M=async e=>{E.value=!0;try{m.value=e,await _()}finally{E.value=!1}},T=async e=>{k.value=!0;try{y.value=e,await _()}finally{k.value=!1}},j=e=>{h.value=e.trim().toLowerCase()},F=i(()=>g.value.filter(e=>e.product_price>=p.value[0]&&e.product_price<=p.value[1]&&(m.value==="all"||e.product_stock===m.value)&&(y.value==="all"||e.product_sklad===y.value)&&e.product_name.toLowerCase().includes(h.value))),w=i(()=>{const e=t=>{const a=F.value.filter(r=>r.product_category===t.category_name),l=a.reduce((r,c)=>{const o=c.product_sub_category||"";return r[o]||(r[o]=[]),r[o].push(c),r},{}),u=[];return Object.entries(l).forEach(([r,c])=>{r!==""&&u.push({id:`subcategory-${r}`,label:r,children:c.map(o=>({id:`product-${o.id}`,label:o.product_name,isProduct:!0,qnt_products:1,price:o.product_price,product_img_url:o.product_img_url})).sort((o,P)=>P.price-o.price),qnt_products:c.length})}),u.sort((r,c)=>c.qnt_products-r.qnt_products),l[""]&&u.push(...l[""].map(r=>({id:`product-${r.id}`,label:r.product_name,isProduct:!0,qnt_products:1,price:r.product_price,product_img_url:r.product_img_url})).sort((r,c)=>c.price-r.price)),{id:`category-${t.id}`,label:t.category_name,children:u,qnt_products:a.length}};return b.value.map(e).filter(t=>t.qnt_products>0).sort((t,a)=>a.qnt_products-t.qnt_products)}),I=i(()=>w.value),_=async()=>{f.value&&typeof f.value.setCheckedKeys=="function"&&(await new Promise(e=>setTimeout(e,0)),f.value.setCheckedKeys(Array.from(d.value)))},B=(e,t)=>{const a=(l,u)=>{u?d.value.add(l.id):d.value.delete(l.id),l.children&&l.children.forEach(r=>a(r,u))};a(t,e.includes(t.id)),_()},$=()=>{h.value="",d.value.clear(),f.value&&(f.value.setCheckedKeys([]),f.value.setExpandedKeys([])),x([n.value,v.value]),M("all"),T("all")},L=()=>{const e=t=>{d.value.add(t.id),t.children&&t.children.forEach(e)};I.value.forEach(e),_()},O=()=>{d.value.size<F.value.length?L():$()},z=async e=>{q.value.has(e)||(await new Promise(t=>setTimeout(t,500)),q.value.add(e))},G=e=>q.value.has(e),N=()=>{switch(le().selectedSupplier){case 0:return"https://resellup.ru";case 1:return"https://www.isa-access.ru";default:return console.warn("Unknown supplier, defaulting to ResellUp"),"https://resellup.ru"}},Q=e=>{const t=N(),a=e.startsWith("/")?"":"/";return`${t}${a}${e}`},W=e=>{f.value=e},H=i(()=>{let e=0;const t=a=>{d.value.has(a.id)?e+=a.qnt_products:a.children&&a.children.forEach(t)};return w.value.forEach(t),e}),J=i(()=>g.value.length),V=i(()=>h.value!==""||p.value[0]!==n.value||p.value[1]!==v.value||m.value!=="all"||y.value!=="all"),X=i(()=>{let e=0;return h.value!==""&&e++,(p.value[0]!==n.value||p.value[1]!==v.value)&&e++,m.value!=="all"&&e++,y.value!=="all"&&e++,e}),R=i(()=>{const e={},t=a=>{if(d.value.has(a.id))if(a.isProduct){const l=a.id.split("-")[1];e[l]||(e[l]=[]),e[l].push(a)}else a.children&&a.children.forEach(t)};return w.value.forEach(t),e}),Y=i(()=>{const e=[],t=a=>{d.value.has(a.id)&&(a.isProduct?e.push(parseInt(a.id.split("-")[1])):a.children&&a.children.forEach(t))};return w.value.forEach(t),e}),Z=i(()=>Object.values(R.value).flat());return{isLoading:S,getSelectedProductsFlat:Z,getSelectedProductsGrouped:R,getSelectedProductIds:Y,activeFiltersCount:X,query:h,setQuery:j,treeRef:f,setTreeRef:W,updateTreeCheckedKeys:_,totalSelectedProducts:H,totalProducts:J,selectAllFiltered:L,resetSelection:$,handleCheck:B,getFullImageUrl:Q,selectedItems:d,fetchData:A,minPrice:n,maxPrice:v,priceRange:p,stockFilter:m,skladFilter:y,setPriceRange:x,setStockFilter:M,setSkladFilter:T,updatePriceRange:D,filteredTreeData:I,hasActiveFilters:V,isStockFilterLoading:E,isSkladFilterLoading:k,loadImage:z,isImageLoaded:G,handleSelectAll:O,filteredProductCount:K}});export{oe as useTreeStore};
